# Quickstart: Token Count Visibility

Get started with Token Count Visibility in under 5 minutes.

## Prerequisites

Before you begin, ensure you have:

- [ ] Claude Code CLI installed and authenticated
- [ ] projspec plugin installed (version 1.0.7+)
- [ ] Python 3.8+ available in PATH

## How It Works

Token Count Visibility automatically tracks **actual LLM API token usage** from your Claude Code sessions:

1. Work on your feature using any projspec commands
2. When your Claude Code session ends, the Stop hook triggers automatically
3. The hook reads Claude's session files from `~/.claude/projects/`
4. Token usage is extracted and aggregated from the session JSONL files
5. Counts are saved to `tokens.json` in your feature directory

**Key benefit**: This tracks **real API token consumption**, not estimates.

## Quick Start

### 1. Work on a Feature

```bash
cd /path/to/project/worktrees/011-my-feature
/projspec:specify Add user authentication with OAuth
/projspec:plan
```

### 2. End Your Session

When you exit Claude Code (or the session times out), the Stop hook runs automatically and creates `tokens.json`:

```
specs/011-my-feature/
├── spec.md
├── plan.md
└── tokens.json   # New file with actual API token usage
```

### 3. View Token Usage

Read the tokens.json file to see actual consumption:

```bash
cat specs/011-my-feature/tokens.json
```

Example output:
```json
{
  "feature_id": "011-my-feature",
  "total_input_tokens": 1192675,
  "total_output_tokens": 45234,
  "total_cache_read_tokens": 18052939,
  "session_count": 2,
  "last_updated": "2026-01-27T14:30:00Z",
  "sessions": [
    {
      "session_id": "9749a9f2-26aa-404f-b410-6c680419eea8",
      "input_tokens": 16247,
      "cache_creation_tokens": 1176428,
      "cache_read_tokens": 18052939,
      "output_tokens": 45000,
      "timestamp": "2026-01-27T12:30:00Z"
    }
  ]
}
```

## Understanding Token Metrics

| Metric | Description | Cost Impact |
|--------|-------------|-------------|
| `input_tokens` | Direct new tokens in context | Full input rate |
| `cache_creation_tokens` | Tokens added to prompt cache | Full input rate |
| `cache_read_tokens` | Tokens served from cache | ~90% cheaper |
| `output_tokens` | Tokens generated by model | Output rate (higher) |

**Billable Input**: `input_tokens + cache_creation_tokens`
**Cache Savings**: `cache_read_tokens` shows how much you saved by caching

## Examples

### Example 1: Check Total Token Usage

View the cumulative token count for a feature:

```bash
cat specs/011-my-feature/tokens.json | jq '{input: .total_input_tokens, output: .total_output_tokens}'
```

Output:
```json
{
  "input": 1192675,
  "output": 45234
}
```

### Example 2: Track Sessions Over Time

See all sessions for a feature:

```bash
cat specs/011-my-feature/tokens.json | jq '.sessions[] | {session: .session_id, input: .input_tokens + .cache_creation_tokens, output: .output_tokens}'
```

Output:
```json
{"session": "9749a9f2-26aa-404f-b410-6c680419eea8", "input": 1192675, "output": 45000}
{"session": "agent-a37b3ed", "input": 120, "output": 234}
```

### Example 3: Find High-Usage Sessions

Identify sessions that used the most tokens:

```bash
cat specs/011-my-feature/tokens.json | jq '.sessions | sort_by(.output_tokens) | reverse | .[0:3]'
```

## Token Data Source

Token usage is read directly from Claude Code's internal session files:

```
~/.claude/projects/[project-path]/[session-id].jsonl
```

Each assistant message in the session file contains actual API usage:
```json
"usage": {
  "input_tokens": 14,
  "cache_creation_input_tokens": 2618,
  "cache_read_input_tokens": 45000,
  "output_tokens": 1
}
```

This provides **100% accurate** token counts - no estimation involved.

## Session Detection

The tool maps your working directory to the Claude project:

| Your Directory | Claude Session Directory |
|----------------|--------------------------|
| `/Users/x/proj/worktrees/011-feature` | `~/.claude/projects/-Users-x-proj-worktrees-011-feature/` |

All `.jsonl` files in that directory are aggregated, including subagent sessions (`agent-*.jsonl`).

## Next Steps

- **Full Specification**: See [spec.md](./spec.md) for complete requirements
- **Data Structure**: See [data-model.md](./data-model.md) for JSON schema details
- **Contributing**: See [tasks.md](./tasks.md) for implementation tasks

## Troubleshooting

### Common Issues

**Issue: tokens.json not created**
```
No tokens.json file appears after ending a session
```
**Solution**: Ensure you're in a valid feature directory (specs/NNN-feature-name/). The Stop hook only runs when it detects a feature directory structure. Also verify the projspec plugin is properly installed with version 1.0.7+.

**Issue: Session files not found**
```
No session data detected for this project
```
**Solution**: The tool looks for sessions in `~/.claude/projects/` based on your working directory path. Ensure Claude Code has been used in this directory. Check that the path matches: `~/.claude/projects/-Your-Full-Path-With-Dashes/`.

**Issue: Token counts seem incomplete**
```
Only partial sessions are showing
```
**Solution**: The tool only counts sessions that have ended. If you're in an active session, that session's tokens won't appear until it ends.

**Issue: jq command not found**
```
jq: command not found
```
**Solution**: jq is optional for viewing JSON nicely. You can still read tokens.json with `cat` or any text editor. To install jq:
- macOS: `brew install jq`
- Ubuntu: `apt install jq`
