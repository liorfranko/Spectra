# Data Model: Token Count Visibility

**Feature**: Token Count Visibility
**Date**: 2026-01-27

## Overview

This data model defines the entities and file formats for tracking actual LLM API token usage across projspec sessions. The model supports per-session tracking, cumulative totals, and full history within a specification lifecycle. Token data is sourced from Claude Code's session files in `~/.claude/projects/`.

---

## Core Entities

### 1. SessionUsage

**Description**: A record of actual API token usage for a single Claude Code session.

**Identifier Pattern**: `session_id` uniquely identifies each entry (UUID or agent-xxx format).

**Storage Location**: Embedded within `tokens.json` sessions array.

**Attributes**:
| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| session_id | string | Yes | Claude session identifier (UUID or agent-xxx format) |
| input_tokens | integer | Yes | Direct input tokens sent to API |
| cache_creation_tokens | integer | Yes | Tokens used for cache creation (billed at input rate) |
| cache_read_tokens | integer | Yes | Tokens read from cache (discounted rate) |
| output_tokens | integer | Yes | Output tokens generated by model |
| timestamp | string | Yes | ISO 8601 timestamp when session ended |

**Validation Rules**:
- `session_id` must be non-empty string matching UUID or agent-xxx pattern
- All token counts must be non-negative integers (≥ 0)
- `timestamp` must be valid ISO 8601 format (e.g., "2026-01-27T14:30:00Z")

**Source Data**:
Token values are extracted from `~/.claude/projects/[project-path]/[session-id].jsonl` files. Each assistant message contains a `usage` field:
```json
"usage": {
  "input_tokens": 14,
  "cache_creation_input_tokens": 2618,
  "cache_read_input_tokens": 45000,
  "output_tokens": 1
}
```

---

### 2. TokenSummary

**Description**: Aggregate view of all API token usage for a feature specification.

**Identifier Pattern**: One TokenSummary per feature, identified by `feature_id`.

**Storage Location**: Root of `tokens.json` file in feature directory.

**Attributes**:
| Attribute | Type | Required | Description |
|-----------|------|----------|-------------|
| feature_id | string | Yes | Identifier matching feature directory name |
| total_input_tokens | integer | Yes | Sum of input + cache_creation tokens across all sessions |
| total_output_tokens | integer | Yes | Sum of output tokens across all sessions |
| total_cache_read_tokens | integer | Yes | Sum of cache read tokens (for reference) |
| session_count | integer | Yes | Number of sessions recorded |
| last_updated | string | Yes | Most recent session timestamp (ISO 8601) |
| sessions | SessionUsage[] | Yes | Array of all SessionUsage entries |

**Validation Rules**:
- `feature_id` must match pattern `[0-9]{3}-[a-z0-9-]+` (e.g., "011-token-count-visibility-for")
- `total_input_tokens` must equal sum of (input_tokens + cache_creation_tokens) across sessions
- `total_output_tokens` must equal sum of output_tokens across sessions
- `last_updated` must equal the most recent timestamp in sessions
- `sessions` must be an array (can be empty for new specs)

**Derived Values**:
- `total_billable_input` = total_input_tokens (cache creation is billed at full rate)
- `total_cache_savings` can be derived from cache_read_tokens (cheaper rate)

---

## Relationships

```
TokenSummary (1) ─────contains──────> SessionUsage (n)
      │                                     │
      │                                     │
      └── feature_id ──> Feature            └── session_id ──> ~/.claude/projects/
              directory                              [project-path]/[session-id].jsonl
```

**Relationship Details**:

| Relationship | Type | Description |
|--------------|------|-------------|
| TokenSummary → SessionUsage | 1:n | One summary contains many session entries |
| SessionUsage → Session File | 1:1 | Each entry references a Claude session JSONL file |
| TokenSummary → Feature | 1:1 | One summary per feature directory |

**Cascade Behavior**:
- When feature directory is deleted, tokens.json is deleted
- Session files in ~/.claude/projects/ are managed by Claude Code, not projspec

---

## State Transitions

### TokenSummary Lifecycle

**States**:
- `empty` - New file, no sessions recorded
- `active` - Has session entries, spec in progress
- `complete` - Spec completed (implicit, no status field)

**Transitions**:
```
[new feature created] ──> empty ──> [first session ends] ──> active
                           │                                    │
                           └──────── [reset on new specify] ────┘
```

**Transition Rules**:
- `empty` → `active`: First Claude Code session ends and Stop hook aggregates usage
- `active` → `active`: Subsequent sessions add to cumulative totals
- Optional reset when new specification starts (controlled by user)

---

## File Format Specifications

### tokens.json

**File Extension**: `.json`
**Location**: `specs/[feature-id]/tokens.json`

**Structure**:
```json
{
  "feature_id": "011-token-count-visibility-for",
  "total_input_tokens": 1192675,
  "total_output_tokens": 45234,
  "total_cache_read_tokens": 18052939,
  "session_count": 3,
  "last_updated": "2026-01-27T14:30:00Z",
  "sessions": [
    {
      "session_id": "9749a9f2-26aa-404f-b410-6c680419eea8",
      "input_tokens": 16247,
      "cache_creation_tokens": 1176428,
      "cache_read_tokens": 18052939,
      "output_tokens": 45000,
      "timestamp": "2026-01-27T12:30:00Z"
    },
    {
      "session_id": "agent-a37b3ed",
      "input_tokens": 120,
      "cache_creation_tokens": 0,
      "cache_read_tokens": 5000,
      "output_tokens": 234,
      "timestamp": "2026-01-27T12:25:00Z"
    }
  ]
}
```

**Fields**:
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| feature_id | string | Yes | Feature identifier |
| total_input_tokens | integer | Yes | Cumulative input + cache creation tokens |
| total_output_tokens | integer | Yes | Cumulative output tokens |
| total_cache_read_tokens | integer | Yes | Cumulative cache read tokens |
| session_count | integer | Yes | Number of sessions in history |
| last_updated | string | Yes | ISO 8601 timestamp |
| sessions | array | Yes | Array of SessionUsage objects |

**Notes**:
- `total_input_tokens` is the billable input: direct input + cache creation
- `total_cache_read_tokens` is tracked for reference (billed at lower rate)
- Sessions include both main sessions (UUIDs) and subagent sessions (agent-xxx)

---

## Project Path Mapping

To find session files for a feature, convert the working directory path:

| Feature Directory | Claude Project Directory |
|-------------------|-------------------------|
| `/Users/x/proj/worktrees/011-feature/` | `~/.claude/projects/-Users-x-proj-worktrees-011-feature/` |

**Algorithm**:
1. Get absolute path of feature directory
2. Replace all `/` with `-`
3. Prepend `~/.claude/projects/`
4. Look for `*.jsonl` files in that directory

---

## Token Metrics Explained

| Metric | Description | Billing Impact |
|--------|-------------|----------------|
| input_tokens | Direct new tokens in context | Full input rate |
| cache_creation_tokens | Tokens added to prompt cache | Full input rate (+ cache storage) |
| cache_read_tokens | Tokens served from cache | Discounted rate (~90% cheaper) |
| output_tokens | Tokens generated by model | Output rate |

**Cost Approximation**:
- Total billable = input_tokens + cache_creation_tokens + (cache_read_tokens * 0.1) + (output_tokens * 5)
- Actual rates vary by model and may change

---

## Validation Rules Summary

| Entity | Rule | Error Action |
|--------|------|--------------|
| SessionUsage | session_id non-empty | ERROR: Skip entry, log warning |
| SessionUsage | all token counts ≥ 0 | ERROR: Set to 0 |
| SessionUsage | timestamp valid ISO 8601 | ERROR: Use current time |
| TokenSummary | feature_id matches directory | WARN: Proceed with mismatch |
| TokenSummary | totals match sum of sessions | ERROR: Recalculate on read |
| tokens.json | Valid JSON syntax | ERROR: Reset file to empty state |
